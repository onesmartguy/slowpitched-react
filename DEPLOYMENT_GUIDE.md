# Deployment Guide - TestFlight Automation

Complete guide to deploying Pitch Height Tracker Pro to TestFlight using EAS Build and Fastlane.

## Overview

This project uses:
- **Expo EAS Build** - Cloud-based iOS builds
- **Fastlane** - Automated TestFlight uploads
- **GitHub Actions** - CI/CD automation
- **App Store Connect API** - Passwordless authentication

## Prerequisites Checklist

- [ ] macOS with Xcode installed (for local testing)
- [ ] Apple Developer Program membership ($99/year)
- [ ] App registered in App Store Connect
- [ ] Expo account (free tier works)
- [ ] Git repository on GitHub

## Setup Process

### Step 1: Fix Build Dependencies

Your dependencies have been updated to match Expo SDK 53. Verify:

```bash
npx expo-doctor
```

All checks should pass. If you see errors, run:

```bash
rm -rf node_modules
pnpm install
```

### Step 2: Remove Native Folders

Since you're using EAS with Prebuild (CNG), remove native folders:

```bash
# These are auto-generated by EAS during build
rm -rf ios android

# Verify they're in .gitignore
git status
```

You should NOT see `ios/` or `android/` in git status.

### Step 3: Create Lock File

EAS Build requires a lock file:

```bash
pnpm install
git add pnpm-lock.yaml
git commit -m "Add pnpm lock file for EAS Build"
```

### Step 4: Set Up App Store Connect API Key

This allows Fastlane to upload to TestFlight without your Apple ID password.

**Create the API Key:**

1. Go to [App Store Connect API Keys](https://appstoreconnect.apple.com/access/api)
2. Click **"+"** to generate a new key
3. Configure:
   - **Name**: `Fastlane CI`
   - **Access**: `App Manager` or higher
4. Click **"Generate"**
5. **Download the .p8 file** (ONLY chance!)
6. Note the **Key ID** and **Issuer ID**

**Configure Locally:**

```bash
cd fastlane
./setup_api_key.sh
```

Follow the prompts and provide:
- Key ID
- Issuer ID
- Path to your .p8 file

This creates a `.env` file with your credentials.

### Step 5: Test EAS Build

```bash
# Build iOS app
eas build --platform ios --profile production

# This will:
# 1. Upload your code to Expo servers
# 2. Generate native iOS project
# 3. Compile the app
# 4. Sign with your certificates
# 5. Create an IPA file
```

**First-time setup**: EAS will ask to create iOS credentials. Choose:
- **Generate new credentials** - Let EAS manage everything (recommended)

This creates:
- Distribution Certificate
- Provisioning Profile
- Stores them encrypted on Expo servers

### Step 6: Test Fastlane Upload

After your build completes:

```bash
# Download the IPA
eas build:download --platform ios --latest --output=build.ipa

# Upload to TestFlight
fastlane upload_only
```

If successful, your build will appear in App Store Connect TestFlight within 5-10 minutes.

### Step 7: Set Up GitHub Actions (Optional)

For automated deployments, add these secrets to GitHub:

**Get Expo Token:**
```bash
npx expo whoami --token
```

**Add GitHub Secrets:**

Go to: `Settings > Secrets and variables > Actions`

| Secret Name | Value | Where to Get |
|-------------|-------|--------------|
| `EXPO_TOKEN` | `expo-xxxxx...` | `npx expo whoami --token` |
| `ASC_KEY_ID` | `ABC123DEFG` | From App Store Connect API page |
| `ASC_ISSUER_ID` | `12345678-1234...` | From App Store Connect API page |
| `ASC_KEY_CONTENT` | `LS0tLS1CRUdJTi...` | Run `cat AuthKey_*.p8 \| base64` |

**Trigger Deployment:**

```bash
# Push a version tag
git tag v1.0.0
git push origin v1.0.0

# Or use GitHub UI: Actions → Deploy to TestFlight → Run workflow
```

## Daily Workflow

### Option 1: Manual Deployment

```bash
# 1. Make your changes
# ... code ...

# 2. Test locally
pnpm start

# 3. Deploy to TestFlight
fastlane deploy
```

This will:
1. Build with EAS
2. Download IPA
3. Upload to TestFlight
4. Clean up build artifacts

### Option 2: Automated Deployment

```bash
# 1. Make your changes and commit
git add .
git commit -m "Add new feature"

# 2. Create a version tag
git tag v1.0.1
git push origin main --tags

# GitHub Actions will automatically:
# - Build with EAS
# - Upload to TestFlight
# - Notify configured groups
```

## Available Fastlane Commands

| Command | Description |
|---------|-------------|
| `fastlane deploy` | Complete flow: build, download, upload |
| `fastlane beta` | Build and upload (alias for deploy) |
| `fastlane build_with_eas` | Just build with EAS |
| `fastlane upload_only` | Upload existing IPA |
| `fastlane bump_build` | Increment build number |

## TestFlight Setup

### Create Test Groups

1. Go to [App Store Connect](https://appstoreconnect.apple.com)
2. Select your app
3. Go to **TestFlight** tab
4. Click **"Create Group"** under **Internal Testing** or **External Testing**
5. Add testers to the group

**Internal Testing:**
- Up to 100 users on your Apple Developer team
- No review process
- Instant access

**External Testing:**
- Up to 10,000 testers
- Requires Apple review (first build only)
- Public TestFlight link option

### Configure Groups in Fastlane

Edit `.env`:

```bash
TESTFLIGHT_GROUPS=Internal Testers,Beta Testers
```

Or pass when deploying:

```bash
TESTFLIGHT_GROUPS="My Team,Beta Users" fastlane upload_only
```

## Version Management

### Semantic Versioning

Use semantic versioning (MAJOR.MINOR.PATCH):

- **MAJOR**: Breaking changes (1.0.0 → 2.0.0)
- **MINOR**: New features (1.0.0 → 1.1.0)
- **PATCH**: Bug fixes (1.0.0 → 1.0.1)

### Build Numbers

EAS automatically increments build numbers when `autoIncrement: true` is set in `eas.json`.

**Manual increment:**

```bash
fastlane bump_build
```

## Monitoring Builds

### EAS Dashboard

View all builds at: https://expo.dev/accounts/[your-account]/projects/slowpitched/builds

### App Store Connect

Check TestFlight status: https://appstoreconnect.apple.com/apps/[app-id]/testflight

### GitHub Actions

See workflow runs: `https://github.com/[your-repo]/actions`

## Troubleshooting

### Build Fails: "Duplicate symbol"

**Solution**: Clean and rebuild

```bash
rm -rf node_modules .expo
pnpm install
eas build --platform ios --profile production --clear-cache
```

### Upload Fails: "Invalid API Key"

**Solution**: Regenerate credentials

```bash
cd fastlane
./setup_api_key.sh
```

### TestFlight Build Not Appearing

**Possible Causes:**

1. **Processing**: Wait 5-10 minutes
2. **Missing Compliance**: Add to `app.json`:
   ```json
   "ITSAppUsesNonExemptEncryption": false
   ```
3. **Invalid Provisioning**: Rebuild with `eas credentials`

### Local Build Fails

```bash
# Clear all caches
rm -rf node_modules .expo ios android
pnpm install

# Try development build
pnpm start
```

## Best Practices

### 1. Pre-flight Checklist

Before deploying:

- [ ] All tests passing (`pnpm test`)
- [ ] No TypeScript errors (`pnpm type-check`)
- [ ] Tested on real device
- [ ] Updated changelog
- [ ] Incremented version if needed

### 2. Meaningful Changelogs

```bash
# Good
CHANGELOG="Fixed camera calibration bug and improved tracking accuracy by 15%"

# Bad
CHANGELOG="Bug fixes and improvements"
```

### 3. Group Testing Strategy

1. **Internal** - Your team (immediate access)
2. **Beta** - Close partners (1-2 days later)
3. **Public** - Wider audience (after validation)

### 4. Version Tagging

```bash
# Tag format: v<version>
git tag -a v1.0.0 -m "Release 1.0.0: Initial public beta"
git push origin v1.0.0
```

## File Structure

```
project/
├── fastlane/
│   ├── Fastfile              # Deployment lanes
│   ├── Appfile               # App configuration
│   ├── setup_api_key.sh      # API key setup script
│   └── README.md             # Fastlane-specific docs
├── .github/workflows/
│   └── testflight.yml        # CI/CD pipeline
├── docs/
│   ├── FASTLANE_SETUP.md          # Detailed Fastlane guide
│   ├── FASTLANE_QUICK_REFERENCE.md # Command reference
│   └── BUILD_FIX_SUMMARY.md       # Dependency fixes
├── .env                      # Local secrets (NOT committed)
├── .env.example              # Template for .env
├── eas.json                  # EAS Build configuration
└── app.json                  # Expo configuration
```

## Security Checklist

- [ ] `.env` is in `.gitignore`
- [ ] `.p8` files are NOT committed
- [ ] GitHub Secrets are configured (for CI/CD)
- [ ] API keys have appropriate permissions (App Manager)
- [ ] Rotate API keys yearly

## Support & Resources

- **Fastlane Docs**: [docs.fastlane.tools](https://docs.fastlane.tools/)
- **EAS Build**: [docs.expo.dev/build](https://docs.expo.dev/build/introduction/)
- **App Store Connect**: [appstoreconnect.apple.com](https://appstoreconnect.apple.com/)
- **Project Docs**:
  - [FASTLANE_SETUP.md](docs/FASTLANE_SETUP.md) - Detailed setup
  - [FASTLANE_QUICK_REFERENCE.md](docs/FASTLANE_QUICK_REFERENCE.md) - Quick commands
  - [BUILD_FIX_SUMMARY.md](docs/BUILD_FIX_SUMMARY.md) - Dependency fixes

## Quick Start TL;DR

```bash
# 1. Fix dependencies (already done)
pnpm install

# 2. Remove native folders
rm -rf ios android

# 3. Set up Fastlane
cd fastlane && ./setup_api_key.sh

# 4. Deploy to TestFlight
fastlane deploy

# Done! Check App Store Connect in 5-10 minutes
```

---

**Last modified by: Claude (AI Agent) on 2025-10-21 10:50 CST**
