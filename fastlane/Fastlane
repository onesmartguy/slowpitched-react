default_platform(:ios)

platform :ios do
  desc "Upload latest built IPA to TestFlight"
  lane :upload_testflight do
    api_key = app_store_connect_api_key(
      key_id: ENV['ASC_KEY_ID'],
      issuer_id: ENV['ASC_ISSUER_ID'],
      key_content: ENV['ASC_KEY_CONTENT'],
      is_key_content_base64: true
    )

    groups = (ENV['TESTFLIGHT_GROUPS'] || "").split(",").map(&:strip).reject(&:empty?)

    pilot(
      api_key: api_key,
      ipa: "build.ipa",
      skip_waiting_for_build_processing: true,   # flip to false if you want to wait
      distribute_external: groups.any?,          # set true if you pass any external groups
      groups: groups                             # requires groups to exist in App Store Connect
    )
  end
end